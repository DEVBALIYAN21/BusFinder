<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Route Details</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        /* Basic Styles */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            background: linear-gradient(to right, #6dd5fa, #2980b9);
            box-sizing: border-box;
        }

        /* Navbar Styling */
        .navbar {
            background-color: white;
            border-bottom: 2px solid #ff6348;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar .logo img {
            height: 80px; /* Adjust size as needed */
        }

        .navbar .nav-links {
            list-style: none;
            display: flex;
            margin: 0;
            padding: 0;
        }

        .navbar .nav-links li {
            margin: 0 10px;
        }

        .navbar .nav-links li a {
            text-decoration: none;
            font-size: 14px;
            color: #333;
            transition: color 0.3s ease;
        }

        .navbar .nav-links li a:hover {
            color: #007bff;
        }

        .navbar .login {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .navbar .login:hover {
            background-color: #0056b3;
        }
        .navbar .center-text {
            flex: 1; /* Allows the text to take up available space */
            text-align: center;
            overflow: hidden; /* Ensure text does not overflow */
            white-space: nowrap; /* Prevent text wrapping */
        }
        
        .navbar .center-text p {
            margin: 0; /* Remove default margin */
            font-size: 40px; /* Adjust font size as needed */
            color: #ff5d5d; /* Set text color */
            font-weight: bold;
            font-family: 'Dancing Script', cursive;;
            text-overflow: ellipsis; /* Add ellipsis for overflow text */
        }

        /* Back Button Styling */
        .back {
            display: flex;
            align-items: center;
            background-color: rgba(255, 165, 2, 1);
            color: rgba(6, 53, 241, 0.8);
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }

        .back i {
            font-size: 20px;
            margin-right: 8px;
            color: black;
        }

        .back:hover {
            background-color: #ff6348;
        }

        /* Main Container */
        .container {
            padding: 15px;
            max-width: 1000px;
            margin: 20px auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .bus-card {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            text-align: center;
        }

        h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        p, li {
            font-size: 16px;
            margin: 8px 0;
        }

        .route-details {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            justify-content: center;
            align-items: center;
            display: none;
        }

        .route-details ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
        }

        .route-details li {
            padding: 5px 10px;
            background-color: #ff5d5d;
            color: white;
            border-radius: 5px;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .route-details li.arrow {
            background-color: transparent;
            color: turquoise;
            font-size: 18px;
            margin-left: 5px;
            margin-right: 5px;
        }

        .toggle-route {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .toggle-route:hover {
            background-color: #0056b3;
        }

        .loading-circle {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            display: none;
        }

        .loading-circle.show {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            padding-top: 50px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 15px;
            border: 1px solid #888;
            width: 90%;
        }

        .close {
            color: #aaaaaa;
            float: right;
            font-size: 24px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .icon {
            font-size: 18px;
            margin-right: 8px;
        }

        .gradient-icon {
            background: linear-gradient(20deg, #fcb045, #fd1d1d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.2em;
            margin-right: 8px;
            display: inline-block;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
        }

        footer {
            border-top: 2px solid #ff6348;
            margin-top: 20px;
            padding: 10px 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            font-size: 14px;
            position: fixed;
            width: 100%;
            bottom: 0;
        }

        .centerdtext {
            font-size: xx-large;
            color: mediumseagreen;
            margin-right: 25%;
        }

        @media (max-width: 768px) {
         .navbar {
        flex-direction: column;
        align-items: center;
        max-height: auto; /* Adjust max-height for mobile */
        padding: 5px; /* Adjust padding for mobile */
    }

    .navbar .logo img {
        height: 50px; /* Adjust height for mobile */
    }

    .navbar .center-text {
        font-size: 16px; /* Adjust font size for mobile */
        padding: 5px; /* Adjust padding for mobile */
        white-space: normal; /* Allow text to wrap */
        overflow: visible; /* Allow text to overflow */
    }

    .navbar .center-text p {
        font-size: 18px; /* Adjust font size for mobile */
        text-overflow: clip; /* Adjust overflow handling */
    }

            .navbar .login {
                font-size: 12px;
            }

            .container {
                width: 100%;
            }

            .bus-card {
                padding: 10px;
            }

            .route-details li {
                font-size: 12px;
            }

            .centerdtext {
                font-size: larger;
                margin-left: 9%;
                color: mediumseagreen;
            }

            .toggle-route, .get-directions {
                padding: 8px 10px;
                font-size: 14px;
            }
        }

    </style>
</head>

<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="logo">
            <img src="icon.png" alt="Bus Finder Logo">
        </div>
        <div class="center-text">
            <p>Buses For You</p>
        </div>
        <a class="back" href="javascript:history.back()">
            <i class="fa fa-home"></i> <!-- Font Awesome home icon -->
            Search Different Route
        </a>
    </div>

    <!-- Main Content -->
    <div class="container" id="busDetails">
        <!-- Bus details will be displayed here -->
        <div class="loading-circle" id="loading-circle">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        &copy; 2024 Bus Finder. All rights reserved.
    </footer>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA-Dl0UYvx2na0oG0mXPPSGxRPxe7-uMfE",
            authDomain: "bus-tracking-2b76e.firebaseapp.com",
            databaseURL: "https://bus-tracking-2b76e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bus-tracking-2b76e",
            storageBucket: "bus-tracking-2b76e.appspot.com",
            messagingSenderId: "964312599473",
            appId: "1:964312599473:web:82dc639eaf2d6451a48b90",
            measurementId: "G-HDBKHSTKML"
        };
    
        // Initialize Firebase

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
// Ensure that each busId is updated only once per second

const lastUpdateMap = {};

// Ensure that each busId is updated only once per second
function updateCurrentStop(busId) {
    const now = Date.now();

    // Check if the busId has been updated in the last second
    if (lastUpdateMap[busId] && (now - lastUpdateMap[busId] < 1000)) {
        console.log(`Skipping update for busId ${busId} due to rate limit.`);
        return;
    }

    // Update the last update time
    lastUpdateMap[busId] = now;

    console.log('Updating current stop for busId:', busId);
    const busRef = db.ref(`buses/${busId}/Current_Details`);

    // Fetch the bus's current details, including latitude, longitude, and isReversed flag
    busRef.once('value')
        .then(snapshot => {
            const busDetails = snapshot.val();
            const busLat = busDetails.latitude;
            const busLng = busDetails.longitude;
            const isReversed = busDetails.isReversed || false;

            if (busLat && busLng) {
                db.ref(`buses/${busId}/Current_Details/Bus_Route`).once('value')
                    .then(stopsSnapshot => {
                        const stops = stopsSnapshot.val();
                        if (stops) {
                            let closestStop = null;
                            let closestDistance = Infinity;

                            const stopNames = Object.keys(stops);

                            // Find the closest stop
                            stopNames.forEach(stopName => {
                                const stopLat = stops[stopName].lat;
                                const stopLng = stops[stopName].long;
                                const distance = calculateDistance(busLat, busLng, stopLat, stopLng);

                                if (distance < closestDistance && distance < 100) {
                                    closestDistance = distance;
                                    closestStop = stopName;
                                }
                            });

                            if (closestStop) {
                                const currentIndex = stopNames.indexOf(closestStop);
                                let previousStopName, nextStopName;

                                // Determine previous and next stops based on direction
                                if (!isReversed) {
                                    previousStopName = currentIndex > 0 ? stopNames[currentIndex - 1] : 'Start of Route';
                                    nextStopName = currentIndex < stopNames.length - 1 ? stopNames[currentIndex + 1] : 'End of Route';

                                    // If we reached the last stop in the normal direction
                                    if (nextStopName === 'End of Route') {
                                        busRef.update({
                                            isReversed: true,
                                            Next: stopNames[currentIndex - 1] // Set next to the previous stop in reverse direction
                                        }).then(() => {
                                            console.log(`Reached the last stop in normal direction. Reversing direction for busId ${busId}.`);
                                        }).catch(error => {
                                            console.error('Error toggling route reversal:', error);
                                        });
                                        nextStopName = stopNames[currentIndex - 1];
                                    }
                                } else {
                                    previousStopName = currentIndex < stopNames.length - 1 ? stopNames[currentIndex + 1] : 'End of Route';
                                    nextStopName = currentIndex > 0 ? stopNames[currentIndex - 1] : 'Start of Route';

                                    // If we reached the first stop in the reversed direction
                                    if (nextStopName === 'Start of Route') {
                                        busRef.update({
                                            isReversed: false,
                                            Next: stopNames[currentIndex + 1] // Set next to the next stop in the forward direction
                                        }).then(() => {
                                            console.log(`Reached the first stop in reversed direction. Reversing back to forward direction for busId ${busId}.`);
                                        }).catch(error => {
                                            console.error('Error toggling route reversal:', error);
                                        });
                                        nextStopName = stopNames[currentIndex + 1];
                                    }
                                }

                                // Update Firebase with the new current, previous, and next stops
                                busRef.update({
                                    Current: closestStop,
                                    Previous: previousStopName,
                                    Next: nextStopName
                                }).then(() => {
                                    console.log('Updated current stop:', closestStop, previousStopName, nextStopName);
                                    updateWebpageCurrentStop(closestStop, previousStopName, nextStopName);
                                }).catch(error => {
                                    console.error('Error updating current stop:', error);
                                });
                            } else {
                                console.log('No stop found within the threshold. Current stop not updated.');
                            }
                        } else {
                            console.log('No stops data found for the bus route.');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching bus route stops:', error);
                    });
            } else {
                console.log('Bus latitude and longitude are missing.');
            }
        })
        .catch(error => {
            console.error('Error fetching bus current details:', error);
        });
}


// Function to calculate the distance between two lat/lng points in meters
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371e3; // Earth radius in meters
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2 - lat1) * Math.PI / 180;
    const Δλ = (lng2 - lng1) * Math.PI / 180;

    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    const distance = R * c; // in meters
    return distance;
}

// Function to update the current stop on the webpage (assuming you have some element to update)
function updateWebpageCurrentStop(currentStopName, previousStopName, nextStopName) {
    const stopElement = document.getElementById('currentStop'); // Update with your actual element ID
    const prevStopElement = document.getElementById('previousStop'); // Update with your actual element ID
    const nextStopElement = document.getElementById('nextStop'); // Update with your actual element ID

    if (stopElement) {
        stopElement.textContent = `Current Stop: ${currentStopName}`;
    }
    if (prevStopElement) {
        prevStopElement.textContent = `Previous Stop: ${previousStopName}`;
    }
    if (nextStopElement) {
        nextStopElement.textContent = `Next Stop: ${nextStopName}`;
    }
}        

        // Helper function to get URL parameters
        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp(`[?&]${name}(=([^&#]*)|&|#|$)`),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
    
        // Get bus IDs from URL
        const busIds = getParameterByName('buses');
    
        if (!busIds) {
            alert('Please provide bus IDs in the URL parameters.');
        } else {
            // Split the bus IDs by comma
            const busIdArray = busIds.split(',');
    
            // Show loading circle if it exists
            const loadingCircle = document.getElementById('loading-circle');
            if (loadingCircle) {
                loadingCircle.classList.add('show');
            }
    
            // Fetch and display bus details for each busId
            Promise.all(busIdArray.map(busId => db.ref('buses/' + busId + '/Current_Details').once('value')))
                .then(snapshots => {
                    const detailsContainer = document.getElementById('busDetails');
                    detailsContainer.innerHTML = '';
    
                    snapshots.forEach(snapshot => {
                        const busDetails = snapshot.val();
                       if (busDetails) {
    const people = busDetails.people_count || 'N/A';
    const busRoute = busDetails.Bus_Route || {}; // Changed to object
    const currentStop = busDetails.Current || 'N/A';
    const NextStop=busDetails.Next;
    const previousStop = busDetails.Previous || 'N/A';
    const latitude = busDetails.latitude || 'N/A';
    const longitude = busDetails.longitude || 'N/A';
    const reversed = busDetails.isReversed;
    
   // Convert bus route to an array of stop names
const busRouteKeys = Object.keys(busRoute);

let predictedNextStop = 'End of Route';
const currentIndex = busRouteKeys.indexOf(currentStop);

// Check if the route is reversed
if (busDetails.isReversed) {
    // Handle reversed route
    if (currentIndex !== -1 && currentIndex > 0) {
        predictedNextStop = busRouteKeys[currentIndex - 1];
    }
    
    // Check if we are at the end of the reversed route
    if (currentIndex === busRouteKeys.length - 1) {
        // Reverse the route back to original order
        const originalRoute = {};
        busRouteKeys.forEach(key => {
            originalRoute[key] = busRoute[key];
        });

        db.ref(`buses/${snapshot.ref.parent.key}/Current_Details`).update({
            Bus_Route: originalRoute,
            isReversed: false
        }).then(() => {
            console.log("Bus route reversed back to original order successfully.");
        }).catch(error => {
            console.error("Error reversing bus route back: ", error);
        });
        
        // Set the predicted next stop to the previous stop in normal mode
        predictedNextStop = previousStop || 'N/A';
    }
} else {
    // Handle normal route
    if (currentIndex !== -1 && currentIndex < busRouteKeys.length - 1) {
        predictedNextStop = busRouteKeys[currentIndex + 1];
    }
    
    // Check if we are at the end of the route
    if (currentIndex === busRouteKeys.length - 1) {
        // Reverse the route and update the bus details
        const reversedRoute = {};
        for (let i = busRouteKeys.length - 1; i >= 0; i--) {
            reversedRoute[busRouteKeys[i]] = busRoute[busRouteKeys[i]];
        }

        db.ref(`buses/${snapshot.ref.parent.key}/Current_Details`).update({
            Bus_Route: reversedRoute,
            isReversed: true
        }).then(() => {
            console.log("Bus route reversed successfully.");
        }).catch(error => {
            console.error("Error reversing bus route: ", error);
        });
        
        // Set the predicted next stop to the previous stop in reversed mode
        predictedNextStop = busRouteKeys[currentIndex - 1] || 'N/A';
    }
}

// Update the webpage with the predicted next stop


                            detailsContainer.innerHTML += `
                                <div class="bus-card">
                                    <h2 style="color: #003366; font-size: 2em; font-weight: bold; margin-bottom: 10px;">
                                        <i class="fas fa-bus icon" style="color: #00bfae; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4); font-size: 2.2em; margin-right: 10px; transform: rotate(10deg);"></i>
                                        Bus ID: ${snapshot.ref.parent.key} Details
                                    </h2>
                                    <p><i class="fas fa-users icon gradient-icon"></i> People Count: ${people}</p>
                                    <p><i class="fas fa-arrow-right icon gradient-icon"></i> Current Stop: ${currentStop}</p>
                                    <p><i class="fas fa-arrow-right icon gradient-icon"></i> Next Stop: ${NextStop}</p>
                                    <button class="toggle-route btn btn-primary" data-id="${snapshot.ref.parent.key}">Show Route</button>
                                    <button class="btn btn-success get-directions" data-id="${snapshot.ref.parent.key}">Get Directions</button>
                                   <div class="route-details" id="route-${snapshot.ref.parent.key}" style="display: none;">
    <ul>
        ${reversed ? 
            busRouteKeys.slice().reverse().map((stop, index, array) => `
                <li>${stop}</li>
                ${index < array.length - 1 ? '<li class="arrow">→</li>' : ''}
            `).join('') 
            : 
            busRouteKeys.map((stop, index, array) => `
                <li>${stop}</li>
                ${index < array.length - 1 ? '<li class="arrow">→</li>' : ''}
            `).join('')
        }
                                        </ul>
                                    </div>
                                </div>
                            `;
                        }
                    });
    
                    // Hide loading circle
                    if (loadingCircle) {
                        loadingCircle.classList.remove('show');
                    }
    
                    document.querySelectorAll('.toggle-route').forEach(button => {
                        button.addEventListener('click', function() {
                            const routeId = this.getAttribute('data-id');
                            const routeDetails = document.getElementById(`route-${routeId}`);
                            if (routeDetails) {
                                // Toggle the route details' display
                                const isHidden = routeDetails.style.display === 'none';
                                routeDetails.style.display = isHidden ? 'block' : 'none';
                                this.textContent = isHidden ? 'Hide Route' : 'Show Route';
                            }
                        });
                    });
        
                    document.querySelectorAll('.get-directions').forEach(button => {
                        button.addEventListener('click', function() {
                            const busId = this.getAttribute('data-id');
                            console.log(`Get directions for Bus ID: ${busId}`);
                        });
                    });
        
                    // Update current stop for each bus
                    busIdArray.forEach(busId => updateCurrentStop(busId));
                    busIdArray.forEach(busId => {
                        setInterval(() => updateCurrentStop(busId), 1000); // Update every 1 second
                    });
                })
                .catch(error => {
                    console.error("Error fetching bus details: ", error);
                    // Hide loading circle if an error occurs
                    if (loadingCircle) {
                        loadingCircle.classList.remove('show');
                    }
                });
        }
    
        // Function to toggle route details
// Function to toggle route details
document.addEventListener('DOMContentLoaded', function() {
    // Bind event listeners to buttons
    document.querySelectorAll('.toggle-route').forEach(button => {
        button.addEventListener('click', function() {
            const routeId = this.getAttribute('data-id');
            const routeDetails = document.getElementById(`route-${routeId}`);
            if (routeDetails) {
                // Toggle the route details' display
                const isHidden = routeDetails.style.display === 'none' || routeDetails.style.display === '';
                routeDetails.style.display = isHidden ? 'block' : 'none';
                this.textContent = isHidden ? 'Hide Route' : 'Show Route';
            }
        });
    });

    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('get-directions')) {
            const busId = event.target.getAttribute('data-id'); // Get the bus ID
           
            // Construct the URL with the bus ID instead of lat/lng
            const mapsUrl = `maps.html?busId=${busId}`;
            window.location.href = mapsUrl;
        }
    });

    // Fetch and display bus details (example code)
    // Assuming this part is already in place
});
    
      /*  // Function to get directions
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('get-directions')) {
                const busId = event.target.getAttribute('data-id'); // Get the bus ID
               
                // Construct the URL with the bus ID instead of lat/lng
                const mapsUrl = `maps.html?busId=${busId}`;
                window.location.href = mapsUrl;
            }
        });*/

        
    </script>
    
    
</body>

</html>

